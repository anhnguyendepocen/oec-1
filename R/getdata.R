#' Downloads and processes the data from the API
#' @description This function accesses \code{atlas.media.mit.edu}and perfoms different API calls to return tidy data.
#' and data transforming.
#' @param origin ISO code for country of origin (e.g. \code{chl} for Chile). Default set to \code{all}.
#' Run \code{country_codes} in case of doubt.
#' @param destination ISO code for country of destination (e.g. \code{chn} for China). Default set to \code{all}.
#' Run \code{country_codes} in case of doubt.
#' @param years Numeric value greater or equal to 1962 and lower of equal to 2016. Default set to 2000.
#' @param classification Any of the available trade classifications in the OEC (\code{sitc}, \code{hs92},
#' \code{hs96}, \code{hs02} or \code{hs07}). Default set to \code{sitc}.
#' @return A tibble that describes bilateral trade metrics (imports, exports, trade balance and relevant metrics
#' such as exports growth w/r to last year) between an \code{origin} and \code{destination} country.
#' @importFrom magrittr %>%
#' @importFrom dplyr as_tibble select filter mutate contains
#' everything left_join bind_rows rename matches
#' @importFrom stringr str_sub str_length
#' @importFrom curl curl new_handle handle_setheaders has_internet
#' @importFrom jsonlite fromJSON
#' @importFrom rlang sym syms is_true
#' @importFrom purrr map_df flatten_df
#' @export
#' @examples
#' \dontrun{
#' # The next examples can take more than 5 seconds to compute, and specially for large economies so
#' # these are just shown without evaluation according to CRAN rules
#'
#' # Run `country_codes` to display the full table of countries
#'
#' # What does Chile export to China?
#' # year 2015 - SITC (4 characters)
#' getdata("chl", "chn", 2015)
#' # or with explicit parameter
#' getdata("chl", "chn", 2015, "sitc")
#'
#' # What does Chile export to China?
#' # years 2010, 2011 and 2015 - HS07 (4 and 6 characters)
#' getdata("chl", "chn", c(2010, 2011, 2015), "hs07")
#' }
#' @keywords functions

getdata <- function(origin = "all", destination = "all", years = 2000, classification = "sitc") {
  # Checks ------------------------------------------------------------------
  if (has_internet() != TRUE) {
    stop("No internet connection.")
  }

  if (all(c(origin, destination) %in%
    oec::country_codes$country_code) != TRUE) {
    stop("Please verify that you wrote the origin
         and destination countries correctly.")
  }

  if (all(years %in% 1962:2016) != TRUE) {
    stop("Please verify that you are requesting data
         contained within the years 1962-2016.")
  }

  match.arg(classification, c("sitc", "hs92", "hs96", "hs02", "hs07"))
  
  if (classification == "sitc") {
    if (all(years >= 1962) != TRUE) {
      stop("Provided that you requested SITC data please
           verify that the data you are requesting is
           contained within the years 1962-2016.")
    }
  }

  if (classification == "hs92") {
    if (all(years >= 1992) != TRUE) {
      stop("Provided that you requested HS92 data please
           verify that the data you are requesting is
           contained within the years 1992-2016.")
    }
  }

  if (classification == "hs96") {
    if (all(years >= 1996) != TRUE) {
      stop("Provided that you requested HS96 data please
           verify that the data you are requesting is
           contained within the years 1996-2016.")
    }
  }

  if (classification == "hs02") {
    if (all(years >= 2002) != TRUE) {
      stop("Provided that you requested HS02 data please
           verify that the data you are requesting is
           contained within the years 2002-2016.")
    }
  }

  if (classification == "hs07") {
    if (all(years >= 2007) != TRUE) {
      stop("Provided that you requested HS07 data please
           verify that the data you are requesting is
           contained within the years 2007-2016.")
    }
  }

  # Valid input message -----------------------------------------------------
  message(
    sprintf("Valid input. Processing %s data...", years)
  )

  # Package data ------------------------------------------------------------
  product_codes <- switch (classification,
                           "hs92" = oec::hs92,
                           "hs96" = oec::hs96,
                           "hs02" = oec::hs02,
                           "hs07" = oec::hs07,
                           "sitc" = oec::sitc
  )

  # Function to read from API -----------------------------------------------
  read_from_api <- function(t, f = "od") {
    url <- switch (f,
                   "od" = sprintf(
                     "https://atlas.media.mit.edu/%s/export/%s/%s/%s/show/",
                     classification,
                     years[t],
                     origin,
                     destination
                   ),
                   "ow" = sprintf(
                     "https://atlas.media.mit.edu/%s/export/%s/%s/all/show/",
                     classification,
                     years[t],
                     origin
                   ),
                   "ww" = sprintf(
                     "https://atlas.media.mit.edu/%s/export/%s/all/all/show/",
                     classification,
                     years[t]
                   )
    )
    
    data <- try(
      flatten_df(fromJSON(url))
    )
    
    if(!is.data.frame(data)) {
      stop("It wasn't possible to obtain data.
           Provided this function tests your internet connection it's probably a server problem.
           Try again later.")
    }
    
    return(data)
  }
  
  # Origin-destination flows ------------------------------------------------
  origin_destination <- map_df(seq_along(years), read_from_api)

  # no data in API message
  if (nrow(origin_destination) == 0) {
    stop("No data available. Try changing years or trade classification.")
  }

  # compute trade balance
  origin_destination <- mutate(origin_destination,
    trade_exchange_val = !!sym("export_val") +
      !!sym("import_val")
  )

  # convert ids to standard hs/sitc
  origin_destination <- origin_destination %>%
    rename(
      id = !!sym(sprintf("%s_id", classification)),
      id_len = !!sym(sprintf("%s_id_len", classification))
    ) %>%
    mutate(
      id = str_sub(!!sym("id"), 3),
      id_len = str_length(!!sym("id"))
    )

  # convert country codes to standard iso3
  if (destination == "all") {
    origin_destination <- mutate(origin_destination, dest_id = "xxall")
  }

  if (origin == "all") {
    origin_destination <- mutate(origin_destination, origin_id = "xxall")
  }

  # include countries (official names)
  origin_destination <- origin_destination %>%
    rename(destination_id = !!sym("dest_id")) %>%
    mutate(
      origin_id = str_sub(!!sym("origin_id"), 3),
      destination_id = str_sub(!!sym("destination_id"), 3)
    ) %>%
    left_join(country_codes, by = c("origin_id" = "country_code")) %>%
    rename(origin_name = !!sym("country")) %>%
    left_join(country_codes, by = c("destination_id" = "country_code")) %>%
    rename(destination_name = !!sym("country"))

  # remove RCAs (if applicable, or this will have duplicates,
  # not all queries return RCAs)
  origin_destination <- select(origin_destination, -matches("rca"))

  # Origin-world flows ------------------------------------------------------
  origin_world <- map_df(seq_along(years), read_from_api, f = "ow")

  # extract RCAs
  origin_world <- origin_world %>%
    rename(
      id = !!sym(sprintf("%s_id", classification)),
      id_len = !!sym(sprintf("%s_id_len", classification))
    ) %>%
    mutate(id = str_sub(!!sym("id"), 3)) %>%
    select(!!sym("id"), contains("_rca"))

  # World-world flows -------------------------------------------------------
  world_world <- map_df(seq_along(years), read_from_api, f = "ww")

  world_world <- rename(world_world,
    world_total_export_val = !!sym("export_val"),
    world_total_import_val = !!sym("import_val")
  )

  # extract ECI and ranks
  world_world <- world_world %>%
    rename(
      id = !!sym(sprintf("%s_id", classification)),
      id_len = !!sym(sprintf("%s_id_len", classification))
    ) %>%
    mutate(id = str_sub(!!sym("id"), 3)) %>%
    select(
      !!sym("id"),
      contains("pci"),
      contains("top_")
    )

  # Join trade flows --------------------------------------------------------
  origin_destination <- origin_destination %>%
    left_join(origin_world, by = "id") %>%
    left_join(world_world, by = "id") %>%
    select(
      !!!syms(c(
        "year",
        "origin_id",
        "destination_id",
        "origin_name",
        "destination_name",
        "id",
        "id_len"
      )),
      contains("export_"),
      contains("import_"),
      everything()
    )

  names(country_codes) <- c("top_importer_code", "top_importer")

  origin_destination <- origin_destination %>%
    rename(top_importer_code = !!sym("top_importer")) %>%
    mutate(top_importer_code = str_sub(!!sym("top_importer_code"), 3)) %>%
    left_join(country_codes, by = "top_importer_code")

  names(country_codes) <- c("top_exporter_code", "top_exporter")

  origin_destination <- origin_destination %>%
    rename(top_exporter_code = !!sym("top_exporter")) %>%
    mutate(top_exporter_code = str_sub(!!sym("top_exporter_code"), 3)) %>%
    left_join(country_codes, by = "top_exporter_code")

  origin_destination <- origin_destination %>%
    left_join(product_codes, by = "id") %>%
    select(
      !!!syms(c(
        "year",
        "origin_id",
        "destination_id",
        "origin_name",
        "destination_name",
        "id",
        "id_len",
        "product_name",
        "group_id",
        "group_name"
      )),
      contains("product_"),
      contains("export_"),
      contains("import_"),
      everything()
    )

  return(origin_destination)
}
